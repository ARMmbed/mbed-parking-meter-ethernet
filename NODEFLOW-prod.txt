[{"id":"add9fb47.b36f98","type":"ibmiot in","z":"ea2de314.e1bb18","authentication":"apiKey","apiKey":"abcb7093.6f029","inputType":"evt","deviceId":"MBED_ENDPOINT_NAME_GOES_HERE","applicationId":"","deviceType":"parking-meter","eventType":"notify","commandType":"","format":"json","name":"parking meter command responses","service":"registered","allDevices":false,"allApplications":"","allDeviceTypes":false,"allEvents":false,"allCommands":"","allFormats":false,"qos":"0","x":168.61114501953125,"y":411.7774353027344,"wires":[["99e0f5bd.45775"]]},{"id":"4cd1aec6.7243a8","type":"inject","z":"ea2de314.e1bb18","name":"Start 60 second Parking Test","topic":"","payload":"{ \"{ \\\"timestamp\\\": \\\"Tue Feb 07 2017 09:55:22 GMT-0600 (CST)\\\", \\\"meterid\\\": \\\"PKM-004\\\", \\\"parking_time\\\": \\\"48\\\"}\": \"\" }","payloadType":"json","repeat":"","crontab":"","once":false,"x":158.79730224609375,"y":222.6346435546875,"wires":[["c34bc15b.a34c8"]]},{"id":"99e0f5bd.45775","type":"switch","z":"ea2de314.e1bb18","name":"Is it the parking meter time value?","property":"payload.path","propertyType":"msg","rules":[{"t":"eq","v":"/100/0/1","vt":"str"}],"checkall":"true","outputs":1,"x":221.28973388671875,"y":279.6505432128906,"wires":[["ee01e546.acee78","2e917d51.da907a"]]},{"id":"2819c4ef.cfbf54","type":"template","z":"ea2de314.e1bb18","name":"Start Parking Countdown","field":"payload","fieldType":"msg","format":"json","syntax":"mustache","template":"{ \"resourceId\":\"100/0/1\", \"payload\":\"eyJjbWQiOiJzdGFydCIsImF1dGgiOiJhcm0xMjM0In0=\", \"deviceId\":\"MBED_ENDPOINT_NAME_GOES_HERE\", \"method\":\"PUT\" }","x":691.4166259765625,"y":360.27362060546875,"wires":[["92a16ca3.7728a8","31ea8972.5effae"]]},{"id":"c2db51b3.ded3e8","type":"switch","z":"ea2de314.e1bb18","name":"Did parking time just get set?","property":"value","propertyType":"msg","rules":[{"t":"gt","v":"5","vt":"num"}],"checkall":"true","outputs":1,"x":439.0240173339844,"y":360.2734680175781,"wires":[["2819c4ef.cfbf54"]]},{"id":"2e917d51.da907a","type":"switch","z":"ea2de314.e1bb18","name":"Did parking time just expire?","property":"payload.payload","propertyType":"msg","rules":[{"t":"eq","v":"MA==","vt":"str"}],"checkall":"true","outputs":1,"x":513.5001220703125,"y":241.28555297851562,"wires":[["9a2faeee.640c18"]]},{"id":"92a16ca3.7728a8","type":"ibmiot out","z":"ea2de314.e1bb18","authentication":"apiKey","apiKey":"abcb7093.6f029","outputType":"cmd","deviceId":"MBED_ENDPOINT_NAME_GOES_HERE","deviceType":"parking-meter","eventCommandType":"put","format":"json","data":"0","qos":"","name":"set parking meter resource value (PUT)","service":"registered","x":887.6068115234375,"y":66.63064575195312,"wires":[]},{"id":"9aa608ee.19ccc8","type":"template","z":"ea2de314.e1bb18","name":"Beacon ON","field":"payload","fieldType":"msg","format":"json","syntax":"mustache","template":"{ \"resourceId\":\"200/0/1\", \"payload\":\"MQ==\", \"deviceId\":\"MBED_ENDPOINT_NAME_GOES_HERE\", \"method\":\"PUT\" }","x":528.6351013183594,"y":129.03568267822266,"wires":[["92a16ca3.7728a8"]]},{"id":"d6625b5c.f6331","type":"template","z":"ea2de314.e1bb18","name":"Beacon OFF","field":"payload","fieldType":"msg","format":"json","syntax":"mustache","template":"{ \"resourceId\":\"200/0/1\", \"payload\":\"MA==\", \"deviceId\":\"MBED_ENDPOINT_NAME_GOES_HERE\", \"method\":\"PUT\" }","x":523.6706848144531,"y":66.17853546142578,"wires":[["92a16ca3.7728a8"]]},{"id":"b8c19585.321d9","type":"inject","z":"ea2de314.e1bb18","name":"Set FREE PARKING","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":267.2024230957031,"y":65.5555648803711,"wires":[["d6625b5c.f6331"]]},{"id":"95c295d6.cf81c8","type":"template","z":"ea2de314.e1bb18","name":"Add 12 seconds to the current Parking Time","field":"payload","fieldType":"msg","format":"json","syntax":"mustache","template":"{ \"resourceId\":\"100/0/1\", \"payload\":\"eyJ2YWx1ZSI6MTIsImNtZCI6InVwZGF0ZSIsImF1dGgiOiJhcm0xMjM0In0=\", \"deviceId\":\"MBED_ENDPOINT_NAME_GOES_HERE\", \"method\":\"PUT\" }","x":507.5359191894531,"y":465.2974548339844,"wires":[["92a16ca3.7728a8"]]},{"id":"9a2faeee.640c18","type":"debug","z":"ea2de314.e1bb18","name":"","active":true,"console":"false","complete":"payload.ep","x":968.881103515625,"y":243.73748779296875,"wires":[]},{"id":"ee01e546.acee78","type":"function","z":"ea2de314.e1bb18","name":"Base64DecodeToValueJSON","func":"var Base64 = {\n    _keyStr: \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\",\n    encode: function(e) {\n        var t = \"\";\n        var n, r, i, s, o, u, a;\n        var f = 0;\n        e = Base64._utf8_encode(e);\n        while (f < e.length) {\n            n = e.charCodeAt(f++);\n            r = e.charCodeAt(f++);\n            i = e.charCodeAt(f++);\n            s = n >> 2;\n            o = (n & 3) << 4 | r >> 4;\n            u = (r & 15) << 2 | i >> 6;\n            a = i & 63;\n            if (isNaN(r)) {\n                u = a = 64\n            } else if (isNaN(i)) {\n                a = 64\n            }\n            t = t + this._keyStr.charAt(s) + this._keyStr.charAt(o) + this._keyStr.charAt(u) + this._keyStr.charAt(a)\n        }\n        return t\n    },\n    decode: function(e) {\n        var t = \"\";\n        var n, r, i;\n        var s, o, u, a;\n        var f = 0;\n        e = e.replace(/[^A-Za-z0-9+/=]/g, \"\");\n        while (f < e.length) {\n            s = this._keyStr.indexOf(e.charAt(f++));\n            o = this._keyStr.indexOf(e.charAt(f++));\n            u = this._keyStr.indexOf(e.charAt(f++));\n            a = this._keyStr.indexOf(e.charAt(f++));\n            n = s << 2 | o >> 4;\n            r = (o & 15) << 4 | u >> 2;\n            i = (u & 3) << 6 | a;\n            t = t + String.fromCharCode(n);\n            if (u != 64) {\n                t = t + String.fromCharCode(r)\n            }\n            if (a != 64) {\n                t = t + String.fromCharCode(i)\n            }\n        }\n        t = Base64._utf8_decode(t);\n        return t\n    },\n    _utf8_encode: function(e) {\n        e = e.replace(/rn/g, \"n\");\n        var t = \"\";\n        for (var n = 0; n < e.length; n++) {\n            var r = e.charCodeAt(n);\n            if (r < 128) {\n                t += String.fromCharCode(r)\n            } else if (r > 127 && r < 2048) {\n                t += String.fromCharCode(r >> 6 | 192);\n                t += String.fromCharCode(r & 63 | 128)\n            } else {\n                t += String.fromCharCode(r >> 12 | 224);\n                t += String.fromCharCode(r >> 6 & 63 | 128);\n                t += String.fromCharCode(r & 63 | 128)\n            }\n        }\n        return t\n    },\n    _utf8_decode: function(e) {\n        var t = \"\";\n        var n = 0;\n        var r, c2;\n        while (n < e.length) {\n            r = e.charCodeAt(n);\n            if (r < 128) {\n                t += String.fromCharCode(r);\n                n++\n            } else if (r > 191 && r < 224) {\n                c2 = e.charCodeAt(n + 1);\n                t += String.fromCharCode((r & 31) << 6 | c2 & 63);\n                n += 2\n            } else {\n                c2 = e.charCodeAt(n + 1);\n                c3 = e.charCodeAt(n + 2);\n                t += String.fromCharCode((r & 15) << 12 | (c2 & 63) << 6 | c3 & 63);\n                n += 3\n            }\n        }\n        return t\n    }\n};\nvar json_str = Base64.decode(msg.payload.payload);\nvar json_obj = JSON.parse(json_str);\nreturn {\"value\":json_obj.value};","outputs":1,"noerr":0,"x":511.0115661621094,"y":311.4636535644531,"wires":[["c2db51b3.ded3e8"]]},{"id":"c12207b8.ffc22","type":"inject","z":"ea2de314.e1bb18","name":"Set PAID PARKING","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":265.7895812988281,"y":128.57132720947266,"wires":[["9aa608ee.19ccc8"]]},{"id":"31ea8972.5effae","type":"debug","z":"ea2de314.e1bb18","name":"","active":false,"console":"false","complete":"false","x":960.8251953125,"y":358.8412780761719,"wires":[]},{"id":"143538fc.f0a9a7","type":"inject","z":"ea2de314.e1bb18","name":"Add To Parking Time","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":212.68252563476562,"y":466.1271667480469,"wires":[["95c295d6.cf81c8"]]},{"id":"2cd962b2.a48676","type":"http in","z":"ea2de314.e1bb18","name":"Free Parking","url":"/freePKM-004","method":"post","swaggerDoc":"","x":84,"y":32.25,"wires":[["e19ee6d8.36f218","d6625b5c.f6331"]]},{"id":"e19ee6d8.36f218","type":"http response","z":"ea2de314.e1bb18","name":"","x":411,"y":27,"wires":[]},{"id":"173719fa.d9b1be","type":"http in","z":"ea2de314.e1bb18","name":"Paid Parking","url":"/paidPKM-004","method":"post","swaggerDoc":"","x":85.5,"y":100,"wires":[["cc81cb85.9d4a68","9aa608ee.19ccc8"]]},{"id":"cc81cb85.9d4a68","type":"http response","z":"ea2de314.e1bb18","name":"","x":399.5,"y":93.75,"wires":[]},{"id":"b01f778d.2d7ec8","type":"http in","z":"ea2de314.e1bb18","name":"Start Parking","url":"/startPKM-004","method":"post","swaggerDoc":"","x":84.5,"y":159,"wires":[["1d92ca1a.7bd18e","c34bc15b.a34c8"]]},{"id":"1d92ca1a.7bd18e","type":"http response","z":"ea2de314.e1bb18","name":"","x":400.5,"y":160.75,"wires":[]},{"id":"6871c4bc.a6ac2c","type":"debug","z":"ea2de314.e1bb18","name":"","active":false,"console":"false","complete":"false","x":957,"y":143,"wires":[]},{"id":"c34bc15b.a34c8","type":"function","z":"ea2de314.e1bb18","name":"Extract Parking Time Key","func":"msg.payload = arr = Object.keys(msg.payload)[0];\nreturn msg; \n","outputs":1,"noerr":0,"x":419.0000305175781,"y":200,"wires":[["bdecb517.e0f668"]]},{"id":"bdecb517.e0f668","type":"function","z":"ea2de314.e1bb18","name":"Create Parking Time JSON","func":"// Set this fudge factor if the network is super slow\nvar fudge_parking_time = 3;\n\n// Endpoint Name\nvar endpoint_name = \"MBED_ENDPOINT_NAME_GOES_HERE\";\n\n// Base64 Support\nvar Base64 = {\n    _keyStr: \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\",\n    encode: function(e) {\n        var t = \"\";\n        var n, r, i, s, o, u, a;\n        var f = 0;\n        e = Base64._utf8_encode(e);\n        while (f < e.length) {\n            n = e.charCodeAt(f++);\n            r = e.charCodeAt(f++);\n            i = e.charCodeAt(f++);\n            s = n >> 2;\n            o = (n & 3) << 4 | r >> 4;\n            u = (r & 15) << 2 | i >> 6;\n            a = i & 63;\n            if (isNaN(r)) {\n                u = a = 64\n            } else if (isNaN(i)) {\n                a = 64\n            }\n            t = t + this._keyStr.charAt(s) + this._keyStr.charAt(o) + this._keyStr.charAt(u) + this._keyStr.charAt(a)\n        }\n        return t\n    },\n    decode: function(e) {\n        var t = \"\";\n        var n, r, i;\n        var s, o, u, a;\n        var f = 0;\n        e = e.replace(/[^A-Za-z0-9+/=]/g, \"\");\n        while (f < e.length) {\n            s = this._keyStr.indexOf(e.charAt(f++));\n            o = this._keyStr.indexOf(e.charAt(f++));\n            u = this._keyStr.indexOf(e.charAt(f++));\n            a = this._keyStr.indexOf(e.charAt(f++));\n            n = s << 2 | o >> 4;\n            r = (o & 15) << 4 | u >> 2;\n            i = (u & 3) << 6 | a;\n            t = t + String.fromCharCode(n);\n            if (u != 64) {\n                t = t + String.fromCharCode(r)\n            }\n            if (a != 64) {\n                t = t + String.fromCharCode(i)\n            }\n        }\n        t = Base64._utf8_decode(t);\n        return t\n    },\n    _utf8_encode: function(e) {\n        e = e.replace(/rn/g, \"n\");\n        var t = \"\";\n        for (var n = 0; n < e.length; n++) {\n            var r = e.charCodeAt(n);\n            if (r < 128) {\n                t += String.fromCharCode(r)\n            } else if (r > 127 && r < 2048) {\n                t += String.fromCharCode(r >> 6 | 192);\n                t += String.fromCharCode(r & 63 | 128)\n            } else {\n                t += String.fromCharCode(r >> 12 | 224);\n                t += String.fromCharCode(r >> 6 & 63 | 128);\n                t += String.fromCharCode(r & 63 | 128)\n            }\n        }\n        return t\n    },\n    _utf8_decode: function(e) {\n        var t = \"\";\n        var n = 0;\n        var r, c2;\n        while (n < e.length) {\n            r = e.charCodeAt(n);\n            if (r < 128) {\n                t += String.fromCharCode(r);\n                n++\n            } else if (r > 191 && r < 224) {\n                c2 = e.charCodeAt(n + 1);\n                t += String.fromCharCode((r & 31) << 6 | c2 & 63);\n                n += 2\n            } else {\n                c2 = e.charCodeAt(n + 1);\n                c3 = e.charCodeAt(n + 2);\n                t += String.fromCharCode((r & 15) << 12 | (c2 & 63) << 6 | c3 & 63);\n                n += 3\n            }\n        }\n        return t\n    }\n};\nvar input_json = JSON.parse(msg.payload);\nvar input_parking_time = Number(input_json.parking_time);\n\n// update our fudge factor for now... we should have better sync between the webapp and the endpoint\nif (input_parking_time >= 60) fudge_parking_time += 9;\nelse if (input_parking_time >= 50) fudge_parking_time += 8;\nelse if (input_parking_time >= 40) fudge_parking_time += 7;\nelse if (input_parking_time >= 30) fudge_parking_time += 5;\nelse if (input_parking_time >= 20) fudge_parking_time += 1;\n\n// update the fudge parking time\ninput_parking_time = input_parking_time - fudge_parking_time;\n\n// create the command JSON\nvar parking_time_json = \"{\\\"value\\\":\";\nvar parking_time_json_1 = parking_time_json.concat(input_parking_time);\nvar parking_time_json_2 = parking_time_json_1.concat(\",\\\"cmd\\\":\\\"set\\\",\\\"auth\\\":\\\"arm1234\\\"}\");\nvar parking_time_json_b64 = Base64.encode(parking_time_json_2);\nvar payload = \"{ \\\"resourceId\\\":\\\"100/0/1\\\", \\\"payload\\\":\\\"\";\nvar payload_1 = payload.concat(parking_time_json_b64);\nvar payload_2 = payload_1.concat(\"\\\", \\\"deviceId\\\":\\\"\");\nvar payload_3 = payload_2.concat(endpoint_name);\nvar payload_4 = payload_3.concat(\"\\\", \\\"method\\\":\\\"PUT\\\" }\");\n\n// assign and return the JSON\nmsg.payload = payload_4;\nreturn msg;","outputs":1,"noerr":0,"x":682,"y":200,"wires":[["6871c4bc.a6ac2c","92a16ca3.7728a8"]]},{"id":"abcb7093.6f029","type":"ibmiot","z":"","name":"My Watson IoT Key","keepalive":"60","cleansession":true,"appId":"","shared":false}]
